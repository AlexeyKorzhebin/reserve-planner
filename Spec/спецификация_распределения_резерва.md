# Спецификация распределения объёма резерва поставщиков по складам (РЦ) с учётом потребности

## Цель
Получить формализованное техническое задание и алгоритм распределения резерва поставщиков по складам (РЦ) на основе потребности, входных ограничений и правил приоритизации.

## Входные данные
- потребность.xlsx (обязательные поля и структура):
  - Колонки: "Код РЦ", "Наименование РЦ", "Код PLU", "Наименование PLU"
  - Произвольное количество столбцов с датами поставки (значения — потребность в штуках)
- резерв.xlsx (обязательные поля и структура):
  - Колонки: "Код РЦ", "Код поставщика", "Код PLU", "Резерв"
  - Ограничители по логистике: "Максимальное кол-во паллет в машине (макс. квант), шт.", "Минимальное кол-во паллет в машине (мин. квант), шт.", "Макс. вес товара на одной паллете, кг"

## Выходные данные (структура)
- Одна таблица распределения со столбцами:
  - "Код РЦ", "Наименование РЦ", "Код PLU", "Наименование PLU", "Дата потребности", "Код поставщика", "Списано из резерва (шт.)", "Остаток резерва (шт.)"
  - Агрегированные показатели: "Заполнено потребности (шт.)", "Дефицит потребности (шт.)", "Неиспользованный резерв (шт.)", "Количество отправок (рейсов)", "Количество паллет", "Вес отправки, кг"
- Итоговые агрегаты по PLU/РЦ/поставщику и по датам потребности.
- Сводка нарушений ограничений и предупреждений (по дате и периоду).

## Ключевые понятия
- Резерв: доступный объём товара PLU от поставщика на РЦ (складе), который можно распределять на покрытие потребностей РЦ.
- РЦ: склад/распределительный центр, идентифицируемый по "Код РЦ".
- PLU: номенклатурная позиция.
- Дата потребности: отдельная колонка-дата в потребности.xlsx; распределение выполняется по датам.
- Квант и вес: логистические ограничения на отгрузку (минимальное и максимальное число паллет; максимальная грузоподъёмность по весу).
- Квантование: правило группировки объёмов в паллеты/рейсы.
- Приоритеты: порядок выбора поставщика/РЦ при наличии нескольких альтернатив.

## Предположения и правила
- Распределение выполняется для каждой даты потребности независимо.
- Резерв может распределяться между несколькими РЦ в пределах PLU.
- Если данных недостаточно для точного расчёта паллет и веса, запрашиваются уточнения до начала расчёта.
- Сохраняется целостность: сумма "Списано из резерва" ≤ исходный "Резерв".
- Если требуется, резерв можно частично зарезервировать на будущие даты; правило предзаказа должно быть определено.
- Приоритет распределения задаётся в следующем порядке (если не указано иное — настраивается):
  1) PLU, затем дата потребности,
  2) РЦ с дефицитом (высший приоритет покрытия дефицита),
  3) Поставщик по принципу «минимальный остаток резерва» или «минимальный срок хранения» (если доступно),
  4) При равенстве — по минимальному числу рейсов, затем по минимальному весу, затем равномерно.
- Округление: объёмы списываются в целых штуках; при необходимости разрешить частичную паллету (указывается).

## Алгоритм распределения
1) Загрузка и проверка данных
- Считать потребность.xlsx и резерв.xlsx.
- Нормализовать ключи: "Код РЦ", "Код PLU", "Дата потребности" (столбцы-даты).
- Выявить расхождения кодов между файлами и отсутствующие PLU/РЦ.
- Рассчитать агрегаты: общий дефицит по PLU/РЦ/дата, суммарный резерв по PLU/РЦ/поставщик.

2) Сопоставление PLU к квантам и весу
- Для каждого PLU получить вес единицы (кг) — запрашивается, если отсутствует в резерве.xlsx.
- Если "Макс. вес товара на одной паллете, кг" задан, вычислить количество единиц на паллете: floor(Макс_вес_паллеты / Вес_единицы).
- Если отсутствует — запросить или задать правило (например, фиксированная вместимость паллеты по SKU).
- Рассчитать "Единиц на паллете" и "Вес паллеты, кг" (входной параметр или расчётный).

3) Инициализация переменных
- Для каждого PLU/поставщика/РЦ инициализировать "Доступный резерв" и "Остаток резерва" = 0.
- Для каждого PLU/РЦ/дата инициализировать "Непокрытая потребность" = 0, "Покрыто" = 0.

4) Покрытие потребностей
- Для каждой даты потребности:
  - Для PLU по приоритетам:
    - Для РЦ с потребностью > 0:
      - Пытаться покрыть из доступных поставщиков по указанным приоритетам.
      - Объём к списанию = min(Доступный резерв у поставщика, Непокрытая потребность РЦ).
      - Обновить "Покрыто" и уменьшить "Доступный резерв" и "Непокрытая потребность".
- При нехватке резерва зафиксировать "Дефицит" по PLU/РЦ/дата.

5) Квантование и рейсы
- Для каждого PLU/поставщика/РЦ и даты, где "Списано из резерва" > 0:
  - Рассчитать количество паллет: ceil(Списано / Единиц на паллете).
  - Проверить мин./макс. кванты:
    - Если "Мин. квант" > 0 и число паллет < Мин. квант:
      - Применить правило: доснять резерв до Мин. кванта (при наличии доступного остатка) или объединить с другими РЦ/датами PLU в пределах горизонта.
    - Если "Макс. квант" задан и число паллет > Макс. квант:
      - Разбить на несколько отправок по Макс. квант; остаток — следующий рейс.
  - Проверить вес:
    - Вес отправки = Паллеты × Вес паллеты.
    - Если вес превышает грузоподъёмность (если задана) или условные ограничения — разбить на дополнительные рейсы.
- Определить "Количество отправок (рейсов)".

6) Оптимизация и балансировка
- При наличии нескольких поставщиков одного PLU — минимизировать число рейсов и суммарный вес/стоимость доставки (при наличии тарифов).
- Если предусмотрено объединение поставок по датам или РЦ — выполнить объединение в пределах заданного горизонта и правила предзаказа.

7) Финализация и контроль
- Сформировать выходную таблицу распределения и агрегаты.
- Выполнить контрольные проверки: сумма списания ≤ резерв; нет отрицательных остатков; соблюдены квантовые/весовые ограничения (с учётом разбиений).
- Сформировать отчёт об ошибках и предупреждениях (неизвестные коды PLU/РЦ, отсутствие веса единицы, нарушения квантов и веса, остатки резервов).

## Уточнения и вопросы (если информация недостаточна)
- Для каждого PLU уточнить вес единицы (кг) или правило расчёта "Единиц на паллете".
- Подтвердить формулу "Единиц на паллете": только по весу или с учётом геометрии/типоразмеров.
- Уточнить логистические ограничения:
  - Грузоподъёмность рейса (т или кг), лимиты по объёму/типу ТС, ограничения по количеству заказов в рейсе.
- Определить правила предзаказа/переноса на будущие даты при дефиците резервов.
- Задать приоритеты распределения: дефицит → поставщик → минимизация рейсов/стоимости/веса.
- Подтвердить правила округления и допустимость частичных паллет.
- Уточнить необходимость и формат выгрузки: Excel, CSV, API; структура и уровень агрегации.
- Определить частоту выполнения (на каждый день, неделю, событийно).
- Указать дополнительные метрики для оптимизации (стоимость доставки, SLA, CO2).

## Требования к реализации и отчётности
- Сохранить трассируемость: для каждого "Списано из резерва" указать источник PLU и поставщика.
- Поддержать обработку произвольного числа колонок-дат в потребности.xlsx.
- Предоставить настройки приоритетов и округления для повторного использования.
- Логирование причин отказов/разбиений рейсов и отклонений от ограничений.

Формат итогового алгоритма и выходных данных должен быть зафиксирован и подтверждён после получения ответов на уточнения.