Обновленный алгоритм: Оптимальный выбор поставщиков
Вот пошаговый алгоритм, который решает эту задачу, с приоритетом на минимизацию общей стоимости закупки.

Входные данные:

Потребность: Таблица РЦ - PLU - Потребность по дням.
Предложения поставщиков: Расширенная таблица, где для каждого PLU есть список поставщиков с их условиями:
Код поставщика
Наименование поставщика
Код PLU, который он поставляет
Цена за кг
Резерв (максимальный объем, который он может поставить) в кг
Макс. вес товара на одной паллете, кг (кратность заказа)
Список обслуживаемых Кодов РЦ (ключевое ограничение!)
Алгоритм
Шаг 1: Агрегация и подготовка данных (для одного PLU)

Выбираем PLU для расчета. Алгоритм выполняется для одной товарной позиции за раз.
Суммируем потребность. Для каждого РЦ рассчитываем общую потребность в кг за весь плановый период.
Создаем "пул предложений". Собираем всех поставщиков, которые могут поставлять данный PLU.
Ранжируем предложения по цене. Для каждого РЦ создаем свой индивидуальный рейтинг поставщиков: от самого дешевого к самому дорогому из тех, кто может поставлять в этот РЦ.
Шаг 2: Основной цикл распределения ("Жадный" алгоритм по цене)

Этот цикл проходит по всем РЦ и старается "закупить" для них товар у самых дешевых доступных поставщиков.

Инициализация: Создаем итоговую таблицу заказов. Для каждого РЦ Непокрытая_Потребность равна его полной потребности.
Итерация по РЦ: Начинаем цикл по каждому РЦ.
Итерация по ранжированным поставщикам: Внутри цикла по РЦ, начинаем итерацию по его списку поставщиков (от самого дешевого).
Проверка доступности поставщика:
Есть ли у текущего поставщика остаток резерва (Резерв_Поставщика > 0)?
Есть ли у текущего РЦ непокрытая потребность (Непокрытая_Потребность > 0)?
Расчет объема закупки: Если оба условия выполнены, определяем, сколько мы можем купить: Объем_Закупки = min(Непокрытая_Потребность_РЦ, Остаток_Резерва_Поставщика)
Фиксация закупки:
Добавляем запись в итоговую таблицу заказов: РЦ - Поставщик - Объем_Закупки.
Уменьшаем Непокрытая_Потребность_РЦ на Объем_Закупки.
Уменьшаем Остаток_Резерва_Поставщика на Объем_Закупки.
Переход: Если потребность РЦ удовлетворена (Непокрытая_Потребность_РЦ == 0), выходим из цикла по поставщикам и переходим к следующему РЦ. Если нет — переходим к следующему по цене поставщику для этого же РЦ.
Шаг 3: Корректировка на кратность паллеты и финализация

Результат Шага 2 — это "идеальное" распределение в кг, но оно не учитывает паллеты.

Пересчет в паллеты: Для каждой созданной строки РЦ - Поставщик - Объем_Закупки:
Кол-во_Паллет = floor(Объем_Закупки / Вес_Паллеты) (округляем ВНИЗ до целого).
Финальный_Объем_Закупки = Кол-во_Паллет * Вес_Паллеты.
Расчет дефицита после округления: После пересчета у каждого РЦ возникнет небольшой дефицит (из-за округления вниз). Суммируем этот дефицит для каждого РЦ.
"Дозакупка" дефицита (второй проход):
Снова проходим по РЦ, у которых остался дефицит.
Пытаемся закрыть этот дефицит, докупая по одной паллете у самого дешевого поставщика из доступных, у которого еще остался резерв (после первого распределения).
Повторяем, пока дефицит не будет покрыт или пока не закончатся резервы у всех поставщиков.
Бизнес-требования для разработки ПО (Версия 2.0)
Раздел "Функциональные требования" нужно серьезно переписать.

FR-1: Импорт данных (расширенный)

FR-1.1: Система должна позволять загружать два файла:
Файл Потребности РЦ: (без изменений).
Файл Предложений Поставщиков: Формат .csv/.xlsx, содержащий обязательные поля: Код поставщика, Наименование поставщика, Код PLU, Наименование PLU, Цена, Резерв, Макс. вес товара на одной паллете, кг, Список кодов РЦ для поставки (например, "127; 159; 182").
FR-2: Интерфейс для запуска расчета

FR-2.1: Пользователь выбирает только Товар (PLU), для которого будет производиться расчет. Система автоматически подхватывает всех поставщиков, предлагающих этот PLU.
FR-3: Алгоритм оптимизации закупок (ключевое изменение)

FR-3.1: Агрегация: Система должна для выбранного PLU агрегировать суточную потребность в общую по каждому РЦ.
FR-3.2: Ранжирование: Для каждого РЦ система должна составить внутренний упорядоченный список доступных ему предложений поставщиков по возрастанию Цены.
FR-3.3: Итеративное покрытие потребности (Первый проход):
Система последовательно для каждого РЦ обращается к его списку поставщиков (от самого дешевого).
Она "резервирует" максимально возможный объем у самого дешевого поставщика, пока не покроет всю потребность РЦ или пока не исчерпает резерв поставщика.
Если резерв поставщика кончился, а потребность РЦ нет, система переходит к следующему по цене поставщику для этого РЦ.
FR-3.4: Корректировка на кратность паллеты:
Система преобразует все "зарезервированные" объемы в килограммах в целое количество паллет, округляя вниз.
Система пересчитывает непокрытый остаток потребности для каждого РЦ.
FR-3.5: Финальная дозакупка (Второй проход):
Система пытается покрыть оставшийся дефицит, добавляя по одной паллете от наиболее дешевых поставщиков, у которых еще есть свободный резерв.
FR-4: Отображение и экспорт результатов (полностью новый формат)

FR-4.1: По завершении расчета система должна выводить детализированный План Закупок: | Код РЦ | Наим. РЦ | Суммарная потребность РЦ, кг | Код Поставщика | Наим. Поставщика | Цена за кг | Заказать паллет, шт. | Заказать кг | Сумма заказа | | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | | 127 | РЦ ЗТЛ | 28 040 | [jg:passport_24] | Поставщик 1 (дешевый) | 95 | 32 | 14 336 | 1 361 920 | | 127 | РЦ ЗТЛ | 28 040 | [jg:passport_25] | Поставщик 2 (дороже) | 105 | 31 | 13 888 | 1 458 240 | | 159 | РЦ ... | ... | [jg:passport_26] | Поставщик 1 (дешевый) | 95 | ... | ... | ... |

FR-4.2: Система должна также отображать сводный отчет:

Общая потребность по PLU: X кг.
Всего закуплено: Y кг.
Процент покрытия потребности: (Y/X) * 100%.
Итоговая стоимость закупки: Z руб.
Средневзвешенная цена закупки: Z / Y руб/кг.
Непокрытый дефицит (если есть): X - Y кг.
FR-4.3: Пользователь должен иметь возможность выгрузить и детализированный План Закупок, и сводный отчет в .csv.