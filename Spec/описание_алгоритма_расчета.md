# Описание алгоритма расчета распределения резерва

Документ описывает фактический алгоритм, реализованный в проекте. Он ориентирован на повторение логики из `Spec/образец распила человеком.xlsx`, даже если входные данные не согласованы между собой.

## 1. Входные данные

### 1.1 Потребность (`потребность.xlsx`)
Таблица с колонками:
- `Код РЦ`, `Наименование РЦ`
- `Код PLU`, `Наименование PLU`
- далее колонки‑даты (формат `YYYY-MM-DD`), значения — потребность в штуках

### 1.2 Резерв (`резерв.xlsx`)
Используемые поля:
- `Код поставщика`, `Наименование поставщика`
- `Код PLU`, `Наименование PLU`
- `Резерв` (используется как справочно; контроль лимита резерва отключен)
- `Максимальное кол-во паллет в машине (макс. квант), шт.`
- `Минимальное кол-во паллет в машине (мин. квант), шт.` (если макс. квант не задан)
- `Макс. вес товара на одной паллете, кг` (используется как вес паллеты)

### 1.3 Образец (`образец распила человеком.xlsx`)
Используемые поля:
- `Дата поставки`
- `SAP поставщика`, `Поставщик`
- `PLU`, `Наименование `
- `РЦ`, `Наименование РЦ`
- `Объем`
- `лог плечо`
- `Квант паллет`
- `паллеты`

Образец используется как шаблон распределения (доли поставщиков и паллеты по ключу `РЦ + PLU + дата`).

## 2. Выходные данные

Формат выходного файла соответствует образцу:
- `Дата поставки`
- `SAP поставщика`, `Поставщик`
- `PLU`, `Наименование `
- `РЦ`, `Наименование РЦ`
- `Объем`
- `ТС` (идентификатор рейса)
- `лог плечо`
- `Квант паллет`
- `паллеты`
- `тс` (пусто)

## 3. Логика алгоритма (по шагам)

### 3.1 Загрузка и нормализация
1) Из `потребность.xlsx` читаются колонки‑даты. Каждая ненулевая потребность превращается в запись:
   - `Код РЦ`, `Код PLU`, `Дата`, `Потребность`
2) Из `резерв.xlsx` читаются:
   - имена поставщиков/PLU
   - вес паллеты по PLU (`Макс. вес товара на одной паллете, кг`)
   - квант (макс./мин. паллет в машине) по поставщику
3) Из `образец распила человеком.xlsx` строится:
   - распределение паллет по ключу `(РЦ, PLU, дата) -> {поставщик: паллеты}`
   - справочник `лог плечо` по ключу `(поставщик, РЦ)`

### 3.2 Расчет “базы” по образцу
Для каждого ключа `(РЦ, PLU, дата)` считается:
- `base_demand` = потребность из входа (если есть)
- `template_pallets_total` = сумма паллет в образце
- `template_pallets_by_supplier` = паллеты по поставщикам в образце

### 3.3 Масштабирование шаблона (основной режим)
Если ключ `(РЦ, PLU, дата)` найден в образце:
1) Если `base_demand > 0`:
   - Паллеты на выходе масштабируются пропорционально спросу:
     ```
     desired_total = round(template_pallets_total * demand / base_demand)
     ```
   - Для каждого поставщика:
     ```
     scaled = floor(template_pallets * demand / base_demand)
     ```
   - Остаток `desired_total - sum(scaled)` распределяется по поставщикам
     с наибольшими дробными остатками (как при округлении по квотам).
2) Если `base_demand == 0`:
   - Если включена опция “Использовать образец при нулевом спросе” —
     берется распределение паллет из образца без изменений.
   - Иначе — пропуск.

Если ключ отсутствует в образце:
- Все паллеты назначаются первому доступному поставщику по PLU (если найден).
- `паллета = ceil(потребность / вес_паллеты)`

### 3.4 Добавление строк без спроса
Если включена опция “Добавлять строки без спроса”:
- Все записи из образца, отсутствующие в спросе, добавляются в выход без изменений.

### 3.5 Упаковка в машины (рейсы)
Аллокации группируются по поставщику:
1) Для каждого поставщика берется квант паллет (макс. квант).
2) Паллеты из аллокаций проходят последовательно по дате, РЦ, PLU.
3) Формируются рейсы:
   - заполняем машину до кванта
   - остаток переходит в следующий рейс
4) `ТС` — это последовательный номер рейса.
5) `лог плечо` берется из образца по `(поставщик, РЦ)`, иначе = 1.

## 4. Пример (из данных образца)

Выбран реальный ключ из образца:  
`РЦ=396 (РЦ 5 Новая Рига)`, `PLU=807`, `дата=2025-11-30`.

### Данные образца
- Поставщик `7000005063` (ЗАО "ЦЧПЯК"): **32 паллеты**
- Поставщик `7000019735` (ООО "Протос" (Адыгея)): **11 паллет**
- Итого `template_pallets_total = 43`

### Данные спроса
Из `потребность.xlsx` для этого ключа:
- `base_demand = 21000` (штук)
- вес паллеты для PLU=807: `520` (шт. на паллету)

### Расчет при исходном спросе 21000
- `desired_total = round(43 * 21000 / 21000) = 43`
- Поставщик 7000005063: `floor(32 * 21000 / 21000) = 32`
- Поставщик 7000019735: `floor(11 * 21000 / 21000) = 11`
- Итого совпадает с образцом: 32 и 11 паллет.

### Расчет при увеличении спроса до 26000
- `desired_total = round(43 * 26000 / 21000) = 53`
- Поставщик 7000005063: `floor(32 * 26000 / 21000) = 39`
- Поставщик 7000019735: `floor(11 * 26000 / 21000) = 13`
- Сумма = 52, остается 1 паллета
- Остаток идет поставщику с максимальным дробным остатком (при равенстве — первому в порядке образца):
  итог: **7000005063 = 40**, **7000019735 = 13**

### Итоговые объемы (при спросе 26000)
- 7000005063: `40 * 520 = 20800` шт.
- 7000019735: `13 * 520 = 6760` шт.
- Итого: `27560` шт.  
  (превышение из‑за округления до паллет)

## 5. Несостыковки и вопросы для аналитика

1) **Единицы измерения**  
   В `потребность.xlsx` значения в штуках, в `резерв.xlsx` и образце —
   используется вес паллеты. Нужно подтвердить: 1 паллета = фиксированная
   вместимость в штуках для PLU, без учета веса брутто?

2) **Поля с датами в резерве**  
   В `резерв.xlsx` есть колонки‑даты, но они пустые. Предполагается,
   что резерв по датам есть, или резерв общий по периоду?

3) **Ограничения по РЦ**  
   В `резерв.xlsx` для поставщика есть список РЦ, но в образце
   встречаются отгрузки вне этих списков. Ограничение считается строгим?

4) **Ограничения по резерву**  
   В образце есть случаи, когда распределение превышает резерв
   поставщика. Нужно ли ограничивать объем резервом или нет?

5) **Правила приоритетов**  
   Сейчас при отсутствии шаблона распределение идет на первого
   поставщика по PLU. Нужна ли логика приоритетов (цена, SLA, плечо)?

6) **Перенос спроса между датами**  
   В образце есть даты с объемами выше/ниже спроса на конкретный день.
   Разрешается ли перераспределять по датам или строго по дате спроса?

7) **Формирование рейсов**  
   Сейчас рейсы формируются подряд по поставщику. Нужны ли
   дополнительные ограничения (разделение по РЦ, по плечу, по PLU)?

8) **Поведение при отсутствии образца**  
   Если образец отсутствует, используется простой режим. Подтвердить:
   достаточно ли этого, или нужен альтернативный “умный” алгоритм?

9) **Поведение при нулевой потребности**  
   Сейчас возможна генерация строк даже при нулевом спросе (опция).
   Это требуется всегда или должно быть выключаемо по умолчанию?

10) **Согласование имен**  
   Входные названия РЦ/PLU/поставщиков могут отличаться между файлами.
   Нужен ли единый справочник и правило приоритетов для имен?

---

Этот документ описывает текущую реализацию и предназначен для проверки
аналитиком и последующей корректировки алгоритма.
